<mat-card class="acta-card">
  <mat-horizontal-stepper linear #stepper>

    <mat-step [stepControl]="responsableForm">
      <form [formGroup]="responsableForm">
        <ng-template matStepLabel>Responsable</ng-template>

        <div class="form-grid">
          <div class="col">
            <mat-form-field appearance="outline">
              <mat-label>Usuario</mat-label>
              <input matInput formControlName="usuario" placeholder="Ingrese usuario..." />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nombre Completo</mat-label>
              <input matInput formControlName="nombre" />
            </mat-form-field>
          </div>

          <div class="col">
            <mat-form-field appearance="outline">
              <mat-label>Cédula</mat-label>
              <input matInput formControlName="cedula" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Cargo</mat-label>
              <input matInput formControlName="cargo" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Correo</mat-label>
              <input matInput formControlName="correo" />
            </mat-form-field>
          </div>
        </div>

        <div class="actions-right">
          <button mat-raised-button color="primary" matStepperNext
            [disabled]="responsableForm.invalid">Siguiente</button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="activosForm">
      <form [formGroup]="activosForm">
        <ng-template matStepLabel>Activos</ng-template>

        @if (activosAgregados().length > 0) {
        <div class="alert-info">
          Activos en cola: <strong>{{ activosAgregados().length }}</strong>
        </div>
        }

        <div class="form-grid">
          <div class="col">
            <mat-form-field appearance="outline">
              <mat-label>Serial</mat-label>
              <input matInput formControlName="serial" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Placa</mat-label>
              <input matInput formControlName="placa" />
            </mat-form-field>
          </div>

          <div class="col">
            <mat-form-field appearance="outline">
              <mat-label>Tipo</mat-label>
              <input matInput formControlName="tipo" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Marca</mat-label>
              <input matInput formControlName="marca" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Modelo</mat-label>
              <input matInput formControlName="modelo" />
            </mat-form-field>
          </div>
        </div>

        <div class="actions">
          <button mat-button matStepperPrevious>Volver</button>
          <button mat-button type="button" (click)="abrirDatosTecnicos()">+Datos Tecnicos</button>
          <button mat-raised-button color="primary" (click)="guardarActivoYContinuar()">
            {{ activosAgregados().length > 0 ? 'Agregar otro / Siguiente' : 'Agregar y Continuar' }}
          </button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="ubicacionForm">
      <form [formGroup]="ubicacionForm">
        <ng-template matStepLabel>Ubicación</ng-template>

        <div class="form-grid three-col">
          <mat-form-field appearance="outline">
            <mat-label>Tienda</mat-label>
            <mat-select formControlName="tiendaId">
              @for (t of tiendas(); track t.id) {
              <mat-option [value]="t.id">{{ t.nombre }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="estado">
              @for (e of estados(); track e) {
              <mat-option [value]="e">{{ e }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Ubicación Detallada</mat-label>
            <input matInput formControlName="ubicacion" placeholder="Ej. Oficina Gerencia" />
          </mat-form-field>
        </div>

        <div class="actions">
          <button mat-button matStepperPrevious>Volver</button>
          <button mat-raised-button color="primary" matStepperNext>Resumen</button>
        </div>
      </form>
    </mat-step>

    <mat-step>
      <ng-template matStepLabel>Resumen</ng-template>

      <div class="resumen-container">
        <div class="info-cards">
          <div class="card-mini">
            <h4>Responsable</h4>
            <p>{{ responsableForm.get('nombre')?.value }}</p>
            <small>{{ responsableForm.get('usuario')?.value }}</small>
          </div>
          <div class="card-mini">
            <h4>Ubicación</h4>
            <p>{{ nombreTiendaSeleccionada }}</p>
            <small>{{ ubicacionForm.get('ubicacion')?.value }}</small>
          </div>
        </div>

        <div class="table-wrapper">
          <h3>Activos Asignados ({{ activosAgregados().length }})</h3>
          <table>
            <thead>
              <tr>
                <th>Serial</th>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Modelo</th>
              </tr>
            </thead>
            <tbody>
              @for (item of activosAgregados(); track item.serial) {
              <tr>
                <td>{{ item.serial }}</td>
                <td>{{ item.placa }}</td>
                <td>{{ item.tipo }}</td>
                <td>{{ item.modelo }}</td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <div class="actions">
        <button mat-stroked-button (click)="agregarElemento()">+ Añadir otro</button>
        <div class="spacer"></div>
        <button mat-button matStepperPrevious>Volver</button>
        <button mat-raised-button color="accent" (click)="cancelarActa()">Cancelar Acta</button>
        <button mat-raised-button color="primary" (click)="confirmarGenerarActa()">Confirmar Acta</button>
      </div>
    </mat-step>

  </mat-horizontal-stepper>
</mat-card>
